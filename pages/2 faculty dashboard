"""
Faculty Dashboard - Cohort Performance Analytics
"""

import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
from plotly.subplots import make_subplots
import seaborn as sns
import matplotlib.pyplot as plt

from core.db import get_bigquery_client, run_query
from core.settings import get_table_ref, COLORS

# Page config MUST be first
st.set_page_config(
    page_title="Faculty Dashboard - MIND",
    page_icon="ðŸ‘¨â€ðŸ«",
    layout="wide"
)

# Initialize session state
if 'authenticated' not in st.session_state:
    st.session_state.authenticated = False
if 'username' not in st.session_state:
    st.session_state.username = None

# Check authentication
if not st.session_state.authenticated:
    st.warning("âš ï¸ Please log in from the Home page")
    st.stop()

# Header
st.markdown("# ðŸ‘¨â€ðŸ« Faculty Dashboard")
st.markdown(f"### Welcome, {st.session_state.username}!")
st.markdown("Monitor student performance and identify at-risk learners")
st.markdown("---")

client = get_bigquery_client()
if not client:
    st.error("âŒ Failed to connect")
    st.stop()

sns.set_style("whitegrid")

def create_fig(figsize=(10, 6)):
    fig, ax = plt.subplots(figsize=figsize, facecolor='white')
    ax.spines['top'].set_visible(False)
    ax.spines['right'].set_visible(False)
    return fig, ax

# KPIs
st.markdown("### ðŸ“Š Teaching Metrics")

students_q = f"SELECT COUNT(DISTINCT user_id) as val FROM {get_table_ref('user')} WHERE role = 'student'"
students_df = run_query(students_q, client)
total_students = int(students_df['val'].iloc[0]) if students_df is not None and not students_df.empty else 0

avg_q = f"SELECT AVG(final_score) as val FROM {get_table_ref('grades')}"
avg_df = run_query(avg_q, client)
avg_score = float(avg_df['val'].iloc[0]) if avg_df is not None and not avg_df.empty else 0

cases_q = f"SELECT COUNT(*) as val FROM {get_table_ref('casestudy')}"
cases_df = run_query(cases_q, client)
total_cases = int(cases_df['val'].iloc[0]) if cases_df is not None and not cases_df.empty else 0

pass_q = f"SELECT COUNT(CASE WHEN final_score >= 70 THEN 1 END) * 100.0 / COUNT(*) as val FROM {get_table_ref('grades')}"
pass_df = run_query(pass_q, client)
pass_rate = float(pass_df['val'].iloc[0]) if pass_df is not None and not pass_df.empty else 0

col1, col2, col3, col4 = st.columns(4)

with col1:
    fig = go.Figure(go.Indicator(mode="number+gauge", value=total_students, title={'text': "ðŸ‘¥ Students"},
        gauge={'axis': {'range': [0, total_students * 1.5]}, 'bar': {'color': COLORS['primary']}}))
    fig.update_layout(height=200, margin=dict(l=10, r=10, t=50, b=10))
    st.plotly_chart(fig, use_container_width=True)

with col2:
    fig = go.Figure(go.Indicator(mode="number+gauge", value=avg_score, title={'text': "ðŸ“ˆ Class Avg"},
        gauge={'axis': {'range': [0, 100]}, 'bar': {'color': COLORS['success']}}))
    fig.update_layout(height=200, margin=dict(l=10, r=10, t=50, b=10))
    st.plotly_chart(fig, use_container_width=True)

with col3:
    fig = go.Figure(go.Indicator(mode="number+gauge", value=total_cases, title={'text': "ðŸ“š Cases"},
        gauge={'axis': {'range': [0, total_cases * 2]}, 'bar': {'color': COLORS['secondary']}}))
    fig.update_layout(height=200, margin=dict(l=10, r=10, t=50, b=10))
    st.plotly_chart(fig, use_container_width=True)

with col4:
    fig = go.Figure(go.Indicator(mode="number+gauge", value=pass_rate, title={'text': "âœ… Pass Rate"},
        gauge={'axis': {'range': [0, 100]}, 'bar': {'color': COLORS['warning']}}))
    fig.update_layout(height=200, margin=dict(l=10, r=10, t=50, b=10))
    st.plotly_chart(fig, use_container_width=True)

st.divider()

# User Growth
st.markdown("### ðŸ“ˆ User Growth")

growth_q = f"""
SELECT DATE(date_added) as date, COUNT(*) as new_users
FROM {get_table_ref('user')}
WHERE date_added >= TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 90 DAY)
GROUP BY date ORDER BY date
"""
growth = run_query(growth_q, client)

if growth is not None and not growth.empty:
    growth['cumulative'] = growth['new_users'].cumsum()
    fig = make_subplots(specs=[[{"secondary_y": True}]])
    fig.add_trace(go.Bar(x=growth['date'], y=growth['new_users'], name="New"), secondary_y=False)
    fig.add_trace(go.Scatter(x=growth['date'], y=growth['cumulative'], name="Total", mode='lines+markers'), secondary_y=True)
    fig.update_layout(title="Daily New vs Cumulative Users", height=400)
    st.plotly_chart(fig, use_container_width=True)

st.divider()

# Activity by Case
st.markdown("### ðŸ“š Activity by Case")

col1, col2, col3 = st.columns(3)

with col1:
    q = f"""
    SELECT c.title, COUNT(DISTINCT g.user) as students
    FROM {get_table_ref('casestudy')} c
    LEFT JOIN {get_table_ref('grades')} g ON c.case_study_id = g.case_study
    GROUP BY c.title ORDER BY students DESC
    """
    data = run_query(q, client)
    if data is not None and not data.empty:
        fig = px.bar(data, x='students', y='title', orientation='h', title="ðŸ‘¥ Students/Case")
        st.plotly_chart(fig, use_container_width=True)

with col2:
    q = f"""
    SELECT c.title, COUNT(s._id) as sessions
    FROM {get_table_ref('casestudy')} c
    LEFT JOIN {get_table_ref('sessions')} s ON c.case_study_id = s.case_study_id
    GROUP BY c.title ORDER BY sessions DESC
    """
    data = run_query(q, client)
    if data is not None and not data.empty:
        fig = px.bar(data, x='sessions', y='title', orientation='h', title="ðŸŽ¯ Sessions/Case")
        st.plotly_chart(fig, use_container_width=True)

with col3:
    q = f"""
    SELECT c.title, COUNT(g._id) as grades
    FROM {get_table_ref('casestudy')} c
    LEFT JOIN {get_table_ref('grades')} g ON c.case_study_id = g.case_study
    GROUP BY c.title ORDER BY grades DESC
    """
    data = run_query(q, client)
    if data is not None and not data.empty:
        fig = px.bar(data, x='grades', y='title', orientation='h', title="âœ… Grades/Case")
        st.plotly_chart(fig, use_container_width=True)

st.divider()

# Grades
st.markdown("### ðŸ“Š Grade Distribution")

col1, col2 = st.columns(2)

with col1:
    scores_q = f"SELECT final_score FROM {get_table_ref('grades')}"
    scores = run_query(scores_q, client)
    if scores is not None and not scores.empty:
        fig, ax = create_fig()
        sns.histplot(data=scores, x='final_score', bins=20, kde=True, ax=ax)
        ax.set_title('Grade Distribution', fontweight='bold')
        ax.axvline(scores['final_score'].mean(), color='red', linestyle='--', label='Mean')
        ax.axvline(70, color='orange', linestyle=':', label='Passing')
        ax.legend()
        plt.tight_layout()
        st.pyplot(fig)

with col2:
    pf_q = f"SELECT CASE WHEN final_score >= 70 THEN 'Pass' ELSE 'Fail' END as status, COUNT(*) as count FROM {get_table_ref('grades')} GROUP BY status"
    pf = run_query(pf_q, client)
    if pf is not None and not pf.empty:
        fig = px.pie(pf, names='status', values='count', title='Pass/Fail')
        st.plotly_chart(fig, use_container_width=True)

st.divider()

# Rubric
st.markdown("### ðŸŽ¯ Rubric Analysis")

rubric_q = f"SELECT AVG(individual_scores.communication) as comm, AVG(individual_scores.comprehension) as comp, AVG(individual_scores.critical_thinking) as crit FROM {get_table_ref('grades')}"
rubric = run_query(rubric_q, client)

if rubric is not None and not rubric.empty:
    comm = float(rubric['comm'].iloc[0] or 0)
    comp = float(rubric['comp'].iloc[0] or 0)
    crit = float(rubric['crit'].iloc[0] or 0)
    
    fig = go.Figure()
    fig.add_trace(go.Scatterpolar(r=[comm, comp, crit, comm], 
        theta=['Communication', 'Comprehension', 'Critical Thinking', 'Communication'], fill='toself'))
    fig.update_layout(polar=dict(radialaxis=dict(visible=True, range=[0, 100])), title="Class Rubric Scores", height=400)
    st.plotly_chart(fig, use_container_width=True)

st.caption("ðŸ’¡ Faculty Dashboard")
