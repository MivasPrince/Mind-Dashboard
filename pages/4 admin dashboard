"""
Admin Dashboard - Institution Analytics
"""

import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
import seaborn as sns
import matplotlib.pyplot as plt

from core.db import get_bigquery_client, run_query
from core.settings import get_table_ref, COLORS

st.set_page_config(page_title="Admin Dashboard", page_icon="âš™ï¸", layout="wide")

if 'authenticated' not in st.session_state:
    st.session_state.authenticated = False
if 'username' not in st.session_state:
    st.session_state.username = None

if not st.session_state.authenticated:
    st.warning("âš ï¸ Please log in from Home")
    st.stop()

st.markdown("# âš™ï¸ Admin Dashboard")
st.markdown(f"### Welcome, {st.session_state.username}!")
st.markdown("Institution-level KPIs")
st.markdown("---")

client = get_bigquery_client()
if not client:
    st.error("âŒ Failed to connect")
    st.stop()

sns.set_style("whitegrid")

def create_fig(figsize=(10, 6)):
    fig, ax = plt.subplots(figsize=figsize, facecolor='white')
    ax.spines['top'].set_visible(False)
    ax.spines['right'].set_visible(False)
    return fig, ax

st.markdown("### ðŸ“Š Executive Summary")

users_q = f"SELECT COUNT(DISTINCT user_id) as val FROM {get_table_ref('user')}"
users_df = run_query(users_q, client)
total_users = int(users_df['val'].iloc[0]) if users_df is not None and not users_df.empty else 0

sessions_q = f"SELECT COUNT(*) as val FROM {get_table_ref('sessions')}"
sessions_df = run_query(sessions_q, client)
total_sessions = int(sessions_df['val'].iloc[0]) if sessions_df is not None and not sessions_df.empty else 0

avg_q = f"SELECT AVG(final_score) as val FROM {get_table_ref('grades')}"
avg_df = run_query(avg_q, client)
avg_score = float(avg_df['val'].iloc[0]) if avg_df is not None and not avg_df.empty else 0

uptime_q = f"SELECT COUNTIF(derived_request_success = TRUE) * 100.0 / COUNT(*) as val FROM {get_table_ref('backend_telemetry')} WHERE http_status_code IS NOT NULL"
uptime_df = run_query(uptime_q, client)
uptime = float(uptime_df['val'].iloc[0]) if uptime_df is not None and not uptime_df.empty else 0

col1, col2, col3, col4 = st.columns(4)

with col1:
    fig = go.Figure(go.Indicator(mode="number+gauge", value=total_users, title={'text': "ðŸ‘¥ Users"},
        gauge={'axis': {'range': [0, total_users * 1.5]}, 'bar': {'color': COLORS['primary']}}))
    fig.update_layout(height=200, margin=dict(l=10, r=10, t=50, b=10))
    st.plotly_chart(fig, use_container_width=True)

with col2:
    fig = go.Figure(go.Indicator(mode="number+gauge", value=total_sessions, title={'text': "ðŸŽ¯ Sessions"},
        gauge={'axis': {'range': [0, total_sessions * 1.5]}, 'bar': {'color': COLORS['secondary']}}))
    fig.update_layout(height=200, margin=dict(l=10, r=10, t=50, b=10))
    st.plotly_chart(fig, use_container_width=True)

with col3:
    fig = go.Figure(go.Indicator(mode="number+gauge", value=avg_score, title={'text': "ðŸ“ˆ Avg Score"},
        gauge={'axis': {'range': [0, 100]}, 'bar': {'color': COLORS['success']}}))
    fig.update_layout(height=200, margin=dict(l=10, r=10, t=50, b=10))
    st.plotly_chart(fig, use_container_width=True)

with col4:
    fig = go.Figure(go.Indicator(mode="number+gauge", value=uptime, title={'text': "âœ… Uptime %"},
        gauge={'axis': {'range': [0, 100]}, 'bar': {'color': COLORS['success']}}))
    fig.update_layout(height=200, margin=dict(l=10, r=10, t=50, b=10))
    st.plotly_chart(fig, use_container_width=True)

st.divider()

st.markdown("### ðŸ“ˆ User Growth")

col1, col2 = st.columns(2)

with col1:
    dau_q = f"""
    SELECT DATE(timestamp) as day, COUNT(DISTINCT user) as active_users
    FROM {get_table_ref('conversation')}
    WHERE timestamp >= TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 30 DAY)
    GROUP BY day ORDER BY day
    """
    dau = run_query(dau_q, client)
    if dau is not None and not dau.empty:
        fig, ax = create_fig()
        sns.lineplot(data=dau, x='day', y='active_users', marker='o', linewidth=3, ax=ax)
        ax.set_title('Daily Active Users (30 Days)', fontweight='bold')
        plt.xticks(rotation=45)
        plt.tight_layout()
        st.pyplot(fig)

with col2:
    role_q = f"SELECT COALESCE(role, 'Unknown') as role, COUNT(*) as count FROM {get_table_ref('user')} GROUP BY role"
    roles = run_query(role_q, client)
    if roles is not None and not roles.empty:
        fig = px.pie(roles, names='role', values='count', title='Users by Role')
        st.plotly_chart(fig, use_container_width=True)

st.divider()

st.markdown("### ðŸ“š Learning Performance")

col1, col2 = st.columns(2)

with col1:
    case_q = f"SELECT c.title, AVG(g.final_score) as avg_score FROM {get_table_ref('casestudy')} c LEFT JOIN {get_table_ref('grades')} g ON c.case_study_id = g.case_study GROUP BY c.title ORDER BY avg_score DESC"
    cases = run_query(case_q, client)
    if cases is not None and not cases.empty:
        fig, ax = create_fig()
        sns.barplot(data=cases, y='title', x='avg_score', palette='RdYlGn', ax=ax)
        ax.set_title('Avg Score by Case', fontweight='bold')
        ax.axvline(70, color='red', linestyle='--', alpha=0.5)
        plt.tight_layout()
        st.pyplot(fig)

with col2:
    scores_q = f"SELECT final_score FROM {get_table_ref('grades')}"
    scores = run_query(scores_q, client)
    if scores is not None and not scores.empty:
        fig, ax = create_fig()
        sns.histplot(data=scores, x='final_score', bins=20, kde=True, ax=ax)
        ax.set_title('Score Distribution', fontweight='bold')
        ax.axvline(scores['final_score'].mean(), color='red', linestyle='--')
        plt.tight_layout()
        st.pyplot(fig)

st.divider()

st.markdown("### ðŸŽ¯ Learning Funnel")

funnel_q = f"""
SELECT 'Registered' as stage, COUNT(DISTINCT user_id) as count, 1 as ord FROM {get_table_ref('user')}
UNION ALL SELECT 'Sessions', COUNT(DISTINCT _id), 2 FROM {get_table_ref('sessions')}
UNION ALL SELECT 'Conversations', COUNT(DISTINCT user), 3 FROM {get_table_ref('conversation')}
UNION ALL SELECT 'Graded', COUNT(DISTINCT user), 4 FROM {get_table_ref('grades')}
ORDER BY ord
"""
funnel = run_query(funnel_q, client)

if funnel is not None and not funnel.empty:
    fig = go.Figure(go.Funnel(y=funnel['stage'], x=funnel['count'], textinfo="value+percent initial"))
    fig.update_layout(title='User Journey Funnel', height=400)
    st.plotly_chart(fig, use_container_width=True)

st.caption("ðŸ’¡ Admin Dashboard")
