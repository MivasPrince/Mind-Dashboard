"""
Faculty Dashboard - VISUAL-RICH Academic Analytics
Charts: box plots, heatmaps, radar, trends, distributions
"""

import sys
from pathlib import Path
sys.path.insert(0, str(Path(__file__).parent.parent))

import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
from core.db import get_bigquery_client, run_query
from core.settings import get_table_ref, COLORS
from core.theme import get_theme_colors

def render():
    st.markdown('<h1 class="main-header">üë®‚Äçüè´ Faculty Dashboard</h1>', unsafe_allow_html=True)
    st.markdown("**Academic Analytics** - Visual insights on learning outcomes")
    
    client = get_bigquery_client()
    if client is None:
        st.error("‚ùå Failed to connect")
        st.stop()
    
    theme = get_theme_colors()
    
    # KPI GAUGES
    st.markdown("### üìä Teaching Metrics")
    
    students_q = f"SELECT COUNT(DISTINCT user_id) as val FROM {get_table_ref('user')} WHERE role = 'student'"
    students_df = run_query(students_q, client)
    total_students = students_df['val'].iloc[0] if students_df is not None else 0
    
    avg_q = f"SELECT AVG(final_score) as val FROM {get_table_ref('grades')}"
    avg_df = run_query(avg_q, client)
    avg_score = avg_df['val'].iloc[0] if avg_df is not None else 0
    
    col1, col2 = st.columns(2)
    
    with col1:
        fig = go.Figure(go.Indicator(
            mode="number+gauge",
            value=total_students,
            title={'text': "üë• Students"},
            gauge={'axis': {'range': [0, total_students * 1.5]}, 'bar': {'color': COLORS['primary']}}
        ))
        fig.update_layout(height=200)
        st.plotly_chart(fig, use_container_width=True)
    
    with col2:
        fig = go.Figure(go.Indicator(
            mode="number+gauge",
            value=avg_score,
            title={'text': "üìà Class Avg"},
            gauge={'axis': {'range': [0, 100]}, 'bar': {'color': COLORS['success']}}
        ))
        fig.update_layout(height=200)
        st.plotly_chart(fig, use_container_width=True)
    
    st.divider()
    
    # COHORT PERFORMANCE - BOX PLOT
    st.markdown("### üéì Cohort Performance Distribution")
    
    dist_q = f"""
    SELECT u.department as cohort, g.final_score
    FROM {get_table_ref('grades')} g
    JOIN {get_table_ref('user')} u ON g.user = u.user_id
    WHERE u.department IS NOT NULL
    """
    dist_data = run_query(dist_q, client)
    
    if dist_data is not None and not dist_data.empty:
        fig = px.box(dist_data, x='cohort', y='final_score', color='cohort')
        fig.update_layout(
            title="Score Distribution by Department",
            height=400,
            showlegend=False
        )
        st.plotly_chart(fig, use_container_width=True)
    
    st.divider()
    
    # RUBRIC RADAR
    st.markdown("### üéØ Class Rubric Analysis")
    
    rubric_q = f"""
    SELECT 
        AVG(individual_scores.communication) as comm,
        AVG(individual_scores.comprehension) as comp,
        AVG(individual_scores.critical_thinking) as crit
    FROM {get_table_ref('grades')}
    """
    rubric_data = run_query(rubric_q, client)
    
    if rubric_data is not None and not rubric_data.empty:
        comm = float(rubric_data['comm'].iloc[0] or 0)
        comp = float(rubric_data['comp'].iloc[0] or 0)
        crit = float(rubric_data['crit'].iloc[0] or 0)
        
        col1, col2 = st.columns([2, 1])
        
        with col1:
            fig = go.Figure()
            fig.add_trace(go.Scatterpolar(
                r=[comm, comp, crit, comm],
                theta=['Communication', 'Comprehension', 'Critical Thinking', 'Communication'],
                fill='toself',
                line_color=COLORS['primary'],
                fillcolor=COLORS['primary'],
                opacity=0.5
            ))
            fig.update_layout(
                polar=dict(radialaxis=dict(visible=True, range=[0, 100])),
                height=400,
                title="Class Average Rubric Scores"
            )
            st.plotly_chart(fig, use_container_width=True)
        
        with col2:
            st.metric("Communication", f"{comm:.1f}")
            st.metric("Comprehension", f"{comp:.1f}")
            st.metric("Critical Thinking", f"{crit:.1f}")
    
    st.divider()
    
    # CASE STUDY EFFECTIVENESS
    st.markdown("### üìö Case Study Performance")
    
    case_q = f"""
    SELECT 
        c.title,
        AVG(g.final_score) as avg_score,
        COUNT(DISTINCT g.user) as students
    FROM {get_table_ref('casestudy')} c
    LEFT JOIN {get_table_ref('grades')} g ON c.case_study_id = g.case_study
    GROUP BY c.title
    ORDER BY avg_score DESC
    """
    case_data = run_query(case_q, client)
    
    if case_data is not None and not case_data.empty:
        fig = px.bar(case_data, x='avg_score', y='title', orientation='h',
                    color='avg_score', color_continuous_scale='RdYlGn')
        fig.update_layout(
            title="Average Score by Case Study",
            height=400,
            showlegend=False
        )
        st.plotly_chart(fig, use_container_width=True)
    
    st.divider()
    
    # PERFORMANCE TREND
    st.markdown("### üìà Class Performance Trend")
    
    trend_q = f"""
    SELECT 
        DATE(timestamp) as date,
        AVG(final_score) as avg_score
    FROM {get_table_ref('grades')}
    WHERE timestamp >= TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 90 DAY)
    GROUP BY date
    ORDER BY date
    """
    trend_data = run_query(trend_q, client)
    
    if trend_data is not None and not trend_data.empty:
        fig = px.line(trend_data, x='date', y='avg_score', markers=True)
        fig.update_traces(line_color=COLORS['primary'], line_width=3)
        fig.update_layout(
            title="Class Average Over Time (90 Days)",
            height=350
        )
        st.plotly_chart(fig, use_container_width=True)
    
    st.divider()
    
    # AT-RISK HEATMAP
    st.markdown("### ‚ö†Ô∏è At-Risk Student Monitoring")
    
    risk_q = f"""
    SELECT 
        u.name,
        AVG(g.final_score) as avg_score,
        COUNT(g._id) as attempts
    FROM {get_table_ref('user')} u
    LEFT JOIN {get_table_ref('grades')} g ON u.user_id = g.user
    WHERE u.role = 'student'
    GROUP BY u.name
    HAVING avg_score < 70 OR attempts < 3
    ORDER BY avg_score ASC
    LIMIT 20
    """
    risk_data = run_query(risk_q, client)
    
    if risk_data is not None and not risk_data.empty:
        fig = px.scatter(risk_data, x='attempts', y='avg_score', 
                        text='name', size='avg_score',
                        color='avg_score', color_continuous_scale='RdYlGn_r')
        fig.update_traces(textposition='top center')
        fig.update_layout(
            title="Students Needing Attention (Score vs Attempts)",
            height=400
        )
        st.plotly_chart(fig, use_container_width=True)
    else:
        st.success("‚úÖ No at-risk students detected!")

if __name__ == "__main__":
    render()
