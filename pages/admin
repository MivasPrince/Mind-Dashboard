"""
Admin Dashboard - Institutional & Strategic View
Executive KPIs, user adoption, learning performance, engagement metrics, system health
"""

import sys
from pathlib import Path
sys.path.insert(0, str(Path(__file__).parent.parent))

import streamlit as st
import pandas as pd
from datetime import datetime, timedelta
from core.db import get_bigquery_client, run_query
from core.settings import get_table_ref
from components.ui import (
    render_kpi_row, render_line_chart, render_bar_chart, render_area_chart,
    render_pie_chart, render_histogram, render_box_plot, render_data_table,
    render_global_filters, render_funnel_chart, format_number, render_data_unavailable
)

def render():
    """Render the enhanced admin dashboard page"""
    
    st.markdown('<h1 class="main-header">üèõÔ∏è Admin Dashboard</h1>', unsafe_allow_html=True)
    st.write("**Institutional & Strategic View** - Leadership analytics for platform governance")
    
    # Get BigQuery client
    client = get_bigquery_client()
    if client is None:
        st.error("Failed to connect to BigQuery")
        st.stop()
    
    # Global Filters
    with st.expander("üîç Filters & Date Range", expanded=False):
        filters = render_global_filters(
            show_date=True,
            show_case_study=True,
            show_cohort=True,
            show_role=True
        )
    
    st.divider()
    
    # ========================================================================
    # A. EXECUTIVE KPI CARDS
    # ========================================================================
    
    st.subheader("üìä Executive Summary")
    
    with st.spinner("Loading executive metrics..."):
        # Total Active Users
        users_query = f"SELECT COUNT(DISTINCT user_id) as total_users FROM {get_table_ref('user')}"
        users_df = run_query(users_query, client)
        total_users = users_df['total_users'].iloc[0] if users_df is not None and not users_df.empty else 0
        
        # Total Sessions
        sessions_query = f"SELECT COUNT(*) as total_sessions FROM {get_table_ref('sessions')}"
        sessions_df = run_query(sessions_query, client)
        total_sessions = sessions_df['total_sessions'].iloc[0] if sessions_df is not None and not sessions_df.empty else 0
        
        # Total Case Studies
        cases_query = f"SELECT COUNT(*) as total_cases FROM {get_table_ref('casestudy')}"
        cases_df = run_query(cases_query, client)
        total_cases = cases_df['total_cases'].iloc[0] if cases_df is not None and not cases_df.empty else 0
        
        # Average Engagement Score
        eng_query = f"""
        SELECT AVG(derived_engagement_score) as avg_engagement
        FROM {get_table_ref('session_analytics')}
        WHERE derived_engagement_score IS NOT NULL
        """
        eng_df = run_query(eng_query, client)
        avg_engagement = eng_df['avg_engagement'].iloc[0] if eng_df is not None and not eng_df.empty else 0
        
        # Average Final Score
        score_query = f"SELECT AVG(final_score) as avg_score FROM {get_table_ref('grades')}"
        score_df = run_query(score_query, client)
        avg_score = score_df['avg_score'].iloc[0] if score_df is not None and not score_df.empty else 0
        
        # Total AI Requests
        ai_query = f"""
        SELECT COUNT(*) as total_ai_requests
        FROM {get_table_ref('backend_telemetry')}
        WHERE derived_ai_total_tokens IS NOT NULL AND derived_ai_total_tokens > 0
        """
        ai_df = run_query(ai_query, client)
        total_ai_requests = ai_df['total_ai_requests'].iloc[0] if ai_df is not None and not ai_df.empty else 0
        
        # System Uptime (based on successful requests)
        uptime_query = f"""
        SELECT 
            COUNTIF(derived_request_success = TRUE) * 100.0 / COUNT(*) as uptime_pct
        FROM {get_table_ref('backend_telemetry')}
        WHERE http_status_code IS NOT NULL
        """
        uptime_df = run_query(uptime_query, client)
        uptime = uptime_df['uptime_pct'].iloc[0] if uptime_df is not None and not uptime_df.empty else 0
        
        # Error Rate
        error_query = f"""
        SELECT 
            COUNTIF(derived_is_error = TRUE) * 100.0 / COUNT(*) as error_rate
        FROM {get_table_ref('backend_telemetry')}
        WHERE http_status_code IS NOT NULL
        """
        error_df = run_query(error_query, client)
        error_rate = error_df['error_rate'].iloc[0] if error_df is not None and not error_df.empty else 0
    
    # Display KPI cards
    render_kpi_row([
        {'title': 'Total Active Users', 'value': f"{total_users:,}", 'icon': 'üë•', 
         'help_text': 'Total registered users on the platform'},
        {'title': 'Total Sessions', 'value': f"{total_sessions:,}", 'icon': 'üéØ',
         'help_text': 'Total learning sessions created'},
        {'title': 'Case Studies', 'value': f"{total_cases:,}", 'icon': 'üìö',
         'help_text': 'Available learning scenarios'},
        {'title': 'Avg Engagement', 'value': f"{avg_engagement:.1f}", 'icon': '‚ö°',
         'help_text': 'Average engagement score across all sessions'}
    ])
    
    render_kpi_row([
        {'title': 'Avg Final Score', 'value': f"{avg_score:.1f}%", 'icon': 'üìà',
         'help_text': 'Average student performance across all grades'},
        {'title': 'AI Requests', 'value': format_number(total_ai_requests), 'icon': 'ü§ñ',
         'help_text': 'Total AI-powered interactions'},
        {'title': 'System Uptime', 'value': f"{uptime:.2f}%", 'icon': '‚úÖ',
         'help_text': 'Percentage of successful requests'},
        {'title': 'Error Rate', 'value': f"{error_rate:.2f}%", 'icon': '‚ö†Ô∏è',
         'help_text': 'Percentage of failed requests'}
    ])
    
    st.divider()
    
    # ========================================================================
    # B. USER & ADOPTION ANALYTICS
    # ========================================================================
    
    st.subheader("üë• User & Adoption Analytics")
    
    col1, col2 = st.columns(2)
    
    with col1:
        # Daily Active Users
        dau_query = f"""
        SELECT 
            DATE(timestamp) as date,
            COUNT(DISTINCT user) as active_users
        FROM {get_table_ref('conversation')}
        WHERE timestamp >= TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 30 DAY)
        GROUP BY DATE(timestamp)
        ORDER BY date
        """
        dau_data = run_query(dau_query, client)
        
        if dau_data is not None and not dau_data.empty:
            render_line_chart(dau_data, 'date', 'active_users', 
                            'Daily Active Users (Last 30 Days)')
        else:
            render_data_unavailable()
    
    with col2:
        # Users by Role
        role_query = f"""
        SELECT 
            COALESCE(role, 'Unknown') as role,
            COUNT(*) as count
        FROM {get_table_ref('user')}
        GROUP BY role
        """
        role_data = run_query(role_query, client)
        
        if role_data is not None and not role_data.empty:
            render_pie_chart(role_data, 'count', 'role', 'Users by Role')
        else:
            render_data_unavailable()
    
    # User Table
    st.markdown("**üë§ User Overview**")
    user_table_query = f"""
    SELECT 
        u.name,
        u.email,
        u.role,
        u.department,
        MAX(c.timestamp) as last_active,
        COUNT(DISTINCT s._id) as total_sessions
    FROM {get_table_ref('user')} u
    LEFT JOIN {get_table_ref('conversation')} c ON u.user_id = c.user
    LEFT JOIN {get_table_ref('sessions')} s ON u.user_id = s._id
    GROUP BY u.name, u.email, u.role, u.department
    ORDER BY last_active DESC
    LIMIT 100
    """
    user_table = run_query(user_table_query, client)
    
    if user_table is not None and not user_table.empty:
        render_data_table(user_table, "Active Users", max_rows=50, key_suffix="users")
    else:
        render_data_unavailable()
    
    st.divider()
    
    # ========================================================================
    # C. LEARNING & PERFORMANCE OVERVIEW
    # ========================================================================
    
    st.subheader("üìö Learning & Performance Overview")
    
    col1, col2 = st.columns(2)
    
    with col1:
        # Average Score by Case Study
        case_score_query = f"""
        SELECT 
            c.title,
            AVG(g.final_score) as avg_score,
            COUNT(g._id) as attempts
        FROM {get_table_ref('casestudy')} c
        LEFT JOIN {get_table_ref('grades')} g ON c.case_study_id = g.case_study
        GROUP BY c.title
        ORDER BY avg_score DESC
        """
        case_score_data = run_query(case_score_query, client)
        
        if case_score_data is not None and not case_score_data.empty:
            render_bar_chart(case_score_data, 'title', 'avg_score',
                           'Average Score by Case Study')
        else:
            render_data_unavailable()
    
    with col2:
        # Score Distribution
        score_dist_query = f"SELECT final_score FROM {get_table_ref('grades')}"
        score_dist_data = run_query(score_dist_query, client)
        
        if score_dist_data is not None and not score_dist_data.empty:
            render_histogram(score_dist_data, 'final_score',
                           'Final Score Distribution', nbins=20)
        else:
            render_data_unavailable()
    
    # Performance over Time
    perf_time_query = f"""
    SELECT 
        DATE(timestamp) as date,
        AVG(final_score) as avg_score
    FROM {get_table_ref('grades')}
    WHERE timestamp >= TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 90 DAY)
    GROUP BY DATE(timestamp)
    ORDER BY date
    """
    perf_time_data = run_query(perf_time_query, client)
    
    if perf_time_data is not None and not perf_time_data.empty:
        render_line_chart(perf_time_data, 'date', 'avg_score',
                        'Performance Trend (Last 90 Days)')
    else:
        render_data_unavailable()
    
    st.divider()
    
    # ========================================================================
    # D. ENGAGEMENT & BEHAVIOR
    # ========================================================================
    
    st.subheader("‚ö° Engagement & Behavior")
    
    col1, col2 = st.columns(2)
    
    with col1:
        # Session Length Distribution
        session_length_query = f"""
        SELECT derived_session_length_minutes as session_length
        FROM {get_table_ref('session_analytics')}
        WHERE derived_session_length_minutes IS NOT NULL
        AND derived_session_length_minutes > 0
        AND derived_session_length_minutes < 120
        """
        session_length_data = run_query(session_length_query, client)
        
        if session_length_data is not None and not session_length_data.empty:
            render_histogram(session_length_data, 'session_length',
                           'Session Length Distribution (Minutes)', nbins=30)
        else:
            render_data_unavailable()
    
    with col2:
        # Engagement Score Trend
        eng_trend_query = f"""
        SELECT 
            DATE(start_timestamp) as date,
            AVG(derived_engagement_score) as avg_engagement
        FROM {get_table_ref('session_analytics')}
        WHERE start_timestamp >= TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 30 DAY)
        AND derived_engagement_score IS NOT NULL
        GROUP BY DATE(start_timestamp)
        ORDER BY date
        """
        eng_trend_data = run_query(eng_trend_query, client)
        
        if eng_trend_data is not None and not eng_trend_data.empty:
            render_line_chart(eng_trend_data, 'date', 'avg_engagement',
                            'Engagement Score Trend (Last 30 Days)')
        else:
            render_data_unavailable()
    
    st.divider()
    
    # ========================================================================
    # E. LEARNING COMPLETION FUNNEL
    # ========================================================================
    
    st.subheader("üéØ Learning Completion Funnel")
    
    funnel_query = f"""
    SELECT 
        'Registered Users' as stage,
        COUNT(DISTINCT user_id) as count,
        1 as order_num
    FROM {get_table_ref('user')}
    
    UNION ALL
    
    SELECT 
        'Started Sessions' as stage,
        COUNT(DISTINCT _id) as count,
        2 as order_num
    FROM {get_table_ref('sessions')}
    
    UNION ALL
    
    SELECT 
        'Had Conversations' as stage,
        COUNT(DISTINCT user) as count,
        3 as order_num
    FROM {get_table_ref('conversation')}
    
    UNION ALL
    
    SELECT 
        'Received Grades' as stage,
        COUNT(DISTINCT user) as count,
        4 as order_num
    FROM {get_table_ref('grades')}
    
    ORDER BY order_num
    """
    funnel_data = run_query(funnel_query, client)
    
    if funnel_data is not None and not funnel_data.empty:
        render_funnel_chart(
            funnel_data['stage'].tolist(),
            funnel_data['count'].tolist(),
            'Learning Journey Funnel'
        )
    else:
        render_data_unavailable()
    
    # Funnel table with conversion rates
    if funnel_data is not None and not funnel_data.empty:
        funnel_with_rates = funnel_data.copy()
        funnel_with_rates['conversion_rate'] = (
            funnel_with_rates['count'] / funnel_with_rates['count'].iloc[0] * 100
        ).round(2)
        
        render_data_table(
            funnel_with_rates[['stage', 'count', 'conversion_rate']],
            "Funnel Metrics",
            enable_download=True,
            key_suffix="funnel"
        )

if __name__ == "__main__":
    render()
