"""
Developer Dashboard - System Health
"""

import streamlit as st
import plotly.express as px
import plotly.graph_objects as go

from core.db import get_bigquery_client, run_query
from core.settings import get_table_ref, COLORS

st.set_page_config(page_title="Developer Dashboard", page_icon="ðŸ’»", layout="wide")

if 'authenticated' not in st.session_state:
    st.session_state.authenticated = False
if 'username' not in st.session_state:
    st.session_state.username = None

if not st.session_state.authenticated:
    st.warning("âš ï¸ Please log in from Home")
    st.stop()

st.markdown("# ðŸ’» Developer Dashboard")
st.markdown(f"### Welcome, {st.session_state.username}!")
st.markdown("System health monitoring")
st.markdown("---")

client = get_bigquery_client()
if not client:
    st.error("âŒ Failed to connect")
    st.stop()

time_range = st.selectbox("Time", ["Last Hour", "Last 24 Hours", "Last 7 Days"], index=1)
interval = {"Last Hour": "1 HOUR", "Last 24 Hours": "1 DAY", "Last 7 Days": "7 DAY"}[time_range]

st.markdown("### ðŸ¥ System Health")

total_q = f"SELECT COUNT(*) as val FROM {get_table_ref('backend_telemetry')} WHERE created_at >= TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL {interval})"
total_df = run_query(total_q, client)
total_req = int(total_df['val'].iloc[0]) if total_df is not None and not total_df.empty else 0

error_q = f"SELECT COUNT(*) as val FROM {get_table_ref('backend_telemetry')} WHERE created_at >= TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL {interval}) AND derived_is_error = TRUE"
error_df = run_query(error_q, client)
errors = int(error_df['val'].iloc[0]) if error_df is not None and not error_df.empty else 0

error_rate = (errors / total_req * 100) if total_req > 0 else 0

col1, col2, col3 = st.columns(3)

with col1:
    fig = go.Figure(go.Indicator(mode="number", value=total_req, title={'text': "ðŸ“¡ Requests"}))
    fig.update_layout(height=150)
    st.plotly_chart(fig, use_container_width=True)

with col2:
    fig = go.Figure(go.Indicator(mode="number", value=errors, title={'text': "âŒ Errors"}))
    fig.update_layout(height=150)
    st.plotly_chart(fig, use_container_width=True)

with col3:
    fig = go.Figure(go.Indicator(mode="number+gauge", value=error_rate, title={'text': "âš ï¸ Error Rate %"},
        gauge={'axis': {'range': [0, 10]}, 'bar': {'color': COLORS['danger'] if error_rate > 5 else COLORS['success']}}))
    fig.update_layout(height=150)
    st.plotly_chart(fig, use_container_width=True)

st.divider()

st.markdown("### â±ï¸ Response Time")

resp_q = f"""
SELECT TIMESTAMP_TRUNC(created_at, HOUR) as hour, AVG(derived_response_time_ms) as avg_resp
FROM {get_table_ref('backend_telemetry')}
WHERE created_at >= TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL {interval}) AND derived_response_time_ms IS NOT NULL
GROUP BY hour ORDER BY hour
"""
resp_data = run_query(resp_q, client)

if resp_data is not None and not resp_data.empty:
    fig = px.line(resp_data, x='hour', y='avg_resp', markers=True, title="Avg Response Time")
    st.plotly_chart(fig, use_container_width=True)

st.caption("ðŸ’¡ Developer Dashboard")
